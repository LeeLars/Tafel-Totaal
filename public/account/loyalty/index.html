<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <meta name="description" content="Bekijk je loyalty punten en voordelen bij Tafel Totaal.">
  
  <title>Loyalty Programma | Tafel Totaal</title>
  
  <!-- Favicon -->
  <link rel="icon" type="image/png" href="/images/site/Favicon-tafel-totaal.png">
  
  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Righteous&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  
  <!-- Stylesheets -->
  <link rel="stylesheet" href="/css/variables.css">
  <link rel="stylesheet" href="/css/base.css">
  <link rel="stylesheet" href="/css/components.css">
  <link rel="stylesheet" href="/css/utilities.css">
  <link rel="stylesheet" href="/css/pages/account.css">
  <script defer src="https://cloud.umami.is/script.js" data-website-id="661d9bc3-2dd9-46e2-a9ab-4c0004911092"></script>
</head>
<body>
  <!-- Header -->
  <div id="header-container"></div>

  <main class="account-page">
    <div class="container">
      <div class="account-layout">
        <!-- Sidebar -->
        <aside class="account-sidebar">
          <div class="account-sidebar__header">
            <div class="account-sidebar__avatar" id="user-avatar">-</div>
            <div class="account-sidebar__info">
              <div class="account-sidebar__name" id="user-name">Laden...</div>
              <div class="account-sidebar__email" id="user-email">-</div>
            </div>
          </div>
          <nav class="account-nav">
            <a href="/account/overzicht/" class="account-nav__link">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                <polyline points="9 22 9 12 15 12 15 22"></polyline>
              </svg>
              Overzicht
            </a>
            <a href="/account/bestellingen/" class="account-nav__link">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"></path>
                <line x1="3" y1="6" x2="21" y2="6"></line>
                <path d="M16 10a4 4 0 0 1-8 0"></path>
              </svg>
              Bestellingen
            </a>
            <a href="/account/loyalty/" class="account-nav__link active">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
              </svg>
              Loyalty Programma
            </a>
            <a href="/account/gegevens/" class="account-nav__link">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                <circle cx="12" cy="7" r="4"></circle>
              </svg>
              Mijn Gegevens
            </a>
            <div class="account-nav__divider"></div>
            <button class="account-nav__link account-nav__link--danger" id="logout-btn">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                <polyline points="16 17 21 12 16 7"></polyline>
                <line x1="21" y1="12" x2="9" y2="12"></line>
              </svg>
              Uitloggen
            </button>
          </nav>
        </aside>

        <!-- Content -->
        <div class="account-content">
          <div class="account-content__header">
            <h1>Loyalty Programma</h1>
            <p>Spaar punten en ontvang exclusieve kortingen op je bestellingen.</p>
          </div>

          <!-- Loading State -->
          <div id="loyalty-loading" class="account-card">
            <div style="text-align: center; padding: var(--space-xl);">
              <div class="spinner" style="margin: 0 auto;"></div>
              <p style="margin-top: var(--space-md); color: var(--color-gray);">Loyalty gegevens laden...</p>
            </div>
          </div>

          <!-- Loyalty Dashboard (hidden until loaded) -->
          <div id="loyalty-dashboard" style="display: none;">
            
            <!-- Tafel Totaal Club Section -->
            <div class="loyalty-section">
              <div class="loyalty-section__header">
                <div>
                  <h2 class="loyalty-section__title">Tafel Totaal Club</h2>
                  <p class="loyalty-section__subtitle">Verdien exclusieve kortingen en leuke upgrades voor je verhuurervaring.</p>
                </div>
              </div>

              <!-- Tier Slider (Print.com style) -->
              <div class="tier-slider">
                <div class="tier-slider__track" id="tier-slider-track">
                  <!-- Tier cards will be rendered here by JS -->
                </div>
                <div class="tier-slider__dots" id="tier-slider-dots">
                  <!-- Dots will be rendered here by JS -->
                </div>
              </div>

              <!-- Yearly Spend Progress Bar -->
              <div class="yearly-progress" id="yearly-progress">
                <div class="yearly-progress__header">
                  <span class="yearly-progress__title">Bestelwaarde dit jaar (<span id="current-year">2026</span>)</span>
                  <span class="yearly-progress__tag" id="tier-retention-tag"></span>
                </div>
                <div class="yearly-progress__bar-container">
                  <div class="yearly-progress__track">
                    <div class="yearly-progress__fill" id="yearly-progress-fill" style="width: 0%;"></div>
                  </div>
                  <div class="yearly-progress__mark" id="yearly-progress-mark" style="left: 0%;"></div>
                </div>
                <div class="yearly-progress__points">
                  <span>€ 0</span>
                  <span id="yearly-mid-point">€ 2.500</span>
                  <span id="yearly-max-point">€ 5.000</span>
                </div>
              </div>
            </div>

            <!-- Points Summary Cards -->
            <div class="points-summary">
              <div class="points-summary__card">
                <div class="points-summary__value" id="available-points">0</div>
                <div class="points-summary__label">Beschikbare punten</div>
              </div>
              <div class="points-summary__card">
                <div class="points-summary__value" id="lifetime-points">0</div>
                <div class="points-summary__label">Punten dit jaar</div>
              </div>
              <div class="points-summary__card">
                <div class="points-summary__value" id="yearly-spend-display">€ 0</div>
                <div class="points-summary__label">Besteed dit jaar</div>
              </div>
            </div>

            <!-- Transaction History -->
            <div class="account-card">
              <div class="account-card__header">
                <h2 class="account-card__title">Puntengeschiedenis</h2>
              </div>
              <div class="loyalty-history" id="history-container">
                <p class="loyalty-history__empty">Nog geen transacties.</p>
              </div>
            </div>

          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Footer -->
  <div id="footer-container"></div>

  <style>
    /* ============================================
       LOYALTY PROGRAM - Print.com Style
       Premium membership slider with gradients
       ============================================ */

    /* Main Loyalty Section */
    .loyalty-section {
      margin-bottom: var(--space-xl);
    }

    .loyalty-section__header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: var(--space-md);
    }

    .loyalty-section__title {
      font-family: var(--font-display);
      font-size: var(--font-size-xl);
      margin: 0;
    }

    .loyalty-section__subtitle {
      color: var(--color-gray);
      font-size: var(--font-size-sm);
      margin-top: var(--space-xs);
    }

    /* Tier Slider Container */
    .tier-slider {
      position: relative;
      overflow: hidden;
      margin-bottom: var(--space-lg);
    }

    .tier-slider__track {
      display: flex;
      gap: var(--space-md);
      overflow-x: auto;
      scroll-behavior: smooth;
      scrollbar-width: none;
      -ms-overflow-style: none;
      padding: var(--space-sm) 0;
    }

    .tier-slider__track::-webkit-scrollbar {
      display: none;
    }

    /* Individual Tier Card (Print.com style) */
    .tier-card {
      flex: 0 0 280px;
      min-height: 320px;
      border-radius: 16px;
      padding: var(--space-xl);
      position: relative;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      display: flex;
      flex-direction: column;
    }

    .tier-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
    }

    .tier-card.current {
      box-shadow: 0 8px 32px rgba(144, 61, 62, 0.3);
    }

    .tier-card.locked {
      opacity: 0.7;
      filter: grayscale(30%);
    }

    /* Active Badge */
    .tier-card__badge {
      position: absolute;
      top: var(--space-md);
      left: var(--space-md);
      background: rgba(255, 255, 255, 0.9);
      color: var(--color-black);
      font-size: 11px;
      font-weight: 700;
      padding: 4px 10px;
      border-radius: 4px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    /* Tier Avatar Circle */
    .tier-card__avatar {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.2);
      backdrop-filter: blur(10px);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      margin: 0 auto var(--space-lg);
      border: 2px solid rgba(255, 255, 255, 0.3);
    }

    .tier-card__avatar-title {
      font-family: var(--font-display);
      font-size: var(--font-size-lg);
      font-weight: 700;
      color: var(--color-white);
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
    }

    .tier-card__avatar-label {
      font-size: 10px;
      color: rgba(255, 255, 255, 0.8);
      text-transform: uppercase;
      letter-spacing: 0.1em;
    }

    /* Tier Content */
    .tier-card__content {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .tier-card__title {
      font-family: var(--font-display);
      font-size: var(--font-size-xl);
      color: var(--color-white);
      margin-bottom: var(--space-xs);
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
    }

    .tier-card__subtitle {
      font-size: var(--font-size-sm);
      color: rgba(255, 255, 255, 0.8);
      margin-bottom: var(--space-md);
    }

    /* Benefits List */
    .tier-card__benefits {
      list-style: none;
      padding: 0;
      margin: 0;
      flex: 1;
    }

    .tier-card__benefits li {
      display: flex;
      align-items: flex-start;
      gap: var(--space-xs);
      font-size: var(--font-size-sm);
      color: var(--color-white);
      margin-bottom: var(--space-xs);
      line-height: 1.4;
    }

    .tier-card__benefits li::before {
      content: '✓';
      color: rgba(255, 255, 255, 0.9);
      font-weight: bold;
      flex-shrink: 0;
    }

    /* Unlock Hint */
    .tier-card__unlock-hint {
      display: flex;
      align-items: center;
      gap: var(--space-xs);
      margin-top: auto;
      padding-top: var(--space-md);
      font-size: var(--font-size-sm);
      color: rgba(255, 255, 255, 0.9);
      border-top: 1px solid rgba(255, 255, 255, 0.2);
    }

    .tier-card__unlock-hint svg {
      flex-shrink: 0;
      opacity: 0.8;
    }

    /* Locked State */
    .tier-card__locked {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      flex: 1;
      text-align: center;
      color: rgba(255, 255, 255, 0.9);
    }

    .tier-card__locked-icon {
      width: 48px;
      height: 48px;
      margin-bottom: var(--space-md);
      opacity: 0.8;
    }

    .tier-card__locked-text {
      font-size: var(--font-size-md);
      font-weight: 500;
      margin-bottom: var(--space-xs);
    }

    .tier-card__locked-subtext {
      font-size: var(--font-size-sm);
      opacity: 0.8;
    }

    /* Old locked text style (deprecated) */
    .tier-card__locked-text-old {
      font-size: var(--font-size-sm);
    }

    /* Slider Dots */
    .tier-slider__dots {
      display: flex;
      justify-content: center;
      gap: var(--space-xs);
      margin-top: var(--space-md);
    }

    .tier-slider__dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--color-light-gray);
      border: none;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .tier-slider__dot.active {
      background: var(--color-primary);
      transform: scale(1.2);
    }

    /* Yearly Spend Progress */
    .yearly-progress {
      background: var(--color-white);
      border: 1px solid var(--color-light-gray);
      padding: var(--space-lg);
      margin-bottom: var(--space-xl);
    }

    .yearly-progress__header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--space-md);
      flex-wrap: wrap;
      gap: var(--space-sm);
    }

    .yearly-progress__title {
      font-weight: 600;
      font-size: var(--font-size-md);
    }

    .yearly-progress__tag {
      background: #FFF3CD;
      color: #856404;
      font-size: 12px;
      font-weight: 600;
      padding: 4px 12px;
      border-radius: 4px;
    }

    .yearly-progress__bar-container {
      position: relative;
      margin-bottom: var(--space-sm);
    }

    .yearly-progress__track {
      height: 8px;
      background: var(--color-light-gray);
      border-radius: 4px;
      overflow: hidden;
    }

    .yearly-progress__fill {
      height: 100%;
      background: var(--color-primary);
      border-radius: 4px;
      transition: width 0.5s ease;
    }

    .yearly-progress__mark {
      position: absolute;
      top: -4px;
      width: 16px;
      height: 16px;
      background: var(--color-white);
      border: 3px solid var(--color-primary);
      border-radius: 50%;
      transform: translateX(-50%);
      transition: left 0.5s ease;
    }

    .yearly-progress__points {
      display: flex;
      justify-content: space-between;
      font-size: var(--font-size-sm);
      color: var(--color-gray);
    }

    /* Points Summary Card */
    .points-summary {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: var(--space-md);
      margin-bottom: var(--space-xl);
    }

    .points-summary__card {
      background: var(--color-white);
      border: 1px solid var(--color-light-gray);
      padding: var(--space-lg);
      text-align: center;
    }

    .points-summary__value {
      font-family: var(--font-display);
      font-size: clamp(1.5rem, 4vw, 2.5rem);
      color: var(--color-primary);
      line-height: 1;
    }

    .points-summary__label {
      font-size: var(--font-size-sm);
      color: var(--color-gray);
      margin-top: var(--space-xs);
    }

    /* Redemption Card */
    .loyalty-redemption {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: var(--space-lg);
      flex-wrap: wrap;
    }

    .loyalty-redemption__value span:first-child {
      display: block;
      font-family: var(--font-display);
      font-size: var(--font-size-2xl);
      color: var(--color-primary);
    }

    .loyalty-redemption__label {
      font-size: var(--font-size-sm);
      color: var(--color-gray);
    }

    .loyalty-redemption__hint {
      font-size: var(--font-size-xs);
      color: var(--color-gray);
      margin-top: var(--space-xs);
    }

    /* Transaction History */
    .loyalty-history__empty {
      text-align: center;
      color: var(--color-gray);
      padding: var(--space-xl);
    }

    .loyalty-history__list {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .loyalty-history__item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: var(--space-md);
      border-bottom: 1px solid var(--color-light-gray);
    }

    .loyalty-history__item:last-child {
      border-bottom: none;
    }

    .loyalty-history__info {
      flex: 1;
    }

    .loyalty-history__description {
      font-weight: 500;
    }

    .loyalty-history__date {
      font-size: var(--font-size-sm);
      color: var(--color-gray);
    }

    .loyalty-history__points {
      font-weight: bold;
      font-size: var(--font-size-lg);
    }

    .loyalty-history__points.positive {
      color: var(--color-success);
    }

    .loyalty-history__points.positive::before {
      content: '+';
    }

    .loyalty-history__points.negative {
      color: var(--color-error);
    }

    /* Responsive */
    @media (max-width: 768px) {
      .tier-card {
        flex: 0 0 260px;
        min-height: 280px;
      }

      .tier-card__avatar {
        width: 80px;
        height: 80px;
      }

      .loyalty-redemption {
        flex-direction: column;
        text-align: center;
      }

      .yearly-progress__header {
        flex-direction: column;
        align-items: flex-start;
      }
    }
  </style>

  <script type="module">
    import { loadHeader } from '/js/components/header.js';
    import { initAuth, getCurrentUser, logout } from '/js/services/auth.js';
    import { loyaltyAPI } from '/js/lib/api.js';
    import { formatPrice, formatDate } from '/js/lib/utils.js';

    let loyaltyData = null;

    async function loadFooter() {
      const container = document.getElementById('footer-container');
      if (!container) return;

      try {
        const basePath = window.location.hostname.includes('github.io') ? '/Tafel-Totaal' : '';
        const response = await fetch(`${basePath}/components/footer.html`);
        if (!response.ok) throw new Error('Failed to load footer');
        container.innerHTML = await response.text();
      } catch (error) {
        console.error('Error loading footer:', error);
      }
    }

    document.addEventListener('DOMContentLoaded', async () => {
      await loadHeader();
      await loadFooter();
      
      // Initialize auth and wait for result
      await initAuth();
      
      const user = getCurrentUser();
      
      // Check if user is logged in - NO AUTO REDIRECT to prevent loops
      // User must click the login link manually
      if (!user) {
        showError('Je bent niet ingelogd. <a href="/login/">Klik hier om in te loggen</a>');
        return;
      }

      // Update sidebar
      document.getElementById('user-name').textContent = `${user.first_name || ''} ${user.last_name || ''}`;
      document.getElementById('user-email').textContent = user.email || '';
      document.getElementById('user-avatar').textContent = (user.first_name || 'U').charAt(0).toUpperCase();

      // Logout handler
      document.getElementById('logout-btn').addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        localStorage.clear();
        sessionStorage.clear();
        document.cookie.split(";").forEach(c => {
          document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/");
        });
        window.location.replace('/');
      });

      // Load loyalty data
      await loadLoyaltyData();
    });

    // Default gradient colors for tiers (must be defined before use)
    const TIER_GRADIENTS = {
      bronze: ['#CD7F32', '#B87333', '#A0522D', '#8B4513', '#CD853F', '#D2691E', '#DEB887'],
      silver: ['#C0C0C0', '#A8A8A8', '#D3D3D3', '#BEBEBE', '#B0B0B0', '#C8C8C8', '#E0E0E0'],
      gold: ['#FFD700', '#FFC125', '#DAA520', '#B8860B', '#FFB90F', '#EEAD0E', '#CD950C'],
      platinum: ['#E5E4E2', '#EAEFF3', '#D9E4ED', '#FFFFFF', '#D4DEE5', '#E8E8E8', '#E1CAE7'],
      diamond: ['#B9F2FF', '#87CEEB', '#ADD8E6', '#E0FFFF', '#AFEEEE', '#00CED1', '#48D1CC']
    };

    const TIER_BACKGROUNDS = {
      bronze: '#FFF5E6',
      silver: '#F5F5F5',
      gold: '#FFFACD',
      platinum: '#F5F9FF',
      diamond: '#E6FFFF'
    };

    async function loadLoyaltyData() {
      try {
        // Debug: Check auth state
        const user = getCurrentUser();
        const hasToken = !!localStorage.getItem('authToken');
        const hasUser = !!localStorage.getItem('user');
        const isLoggedIn = localStorage.getItem('isLoggedIn');
        
        console.log('=== LOYALTY DEBUG INFO ===');
        console.log('Current user:', user);
        console.log('Has authToken:', hasToken);
        console.log('Has user in localStorage:', hasUser);
        console.log('isLoggedIn flag:', isLoggedIn);
        console.log('API Base URL:', window.location.hostname === 'localhost' ? 'http://localhost:3000' : 'https://tafel-totaal-production.up.railway.app');
        
        if (!user) {
          console.warn('No user found - showing login message');
          showError('Je bent niet ingelogd. <a href="/login/">Klik hier om in te loggen</a>');
          return;
        }
        
        if (!hasToken) {
          console.warn('No auth token found - user needs to re-login');
          showError('Authenticatie token ontbreekt. <a href="/login.html?redirect=' + encodeURIComponent(window.location.pathname) + '">Log opnieuw in om verder te gaan</a>');
          return;
        }
        
        console.log('Loading loyalty data from API...');
        const response = await loyaltyAPI.getCustomerLoyalty();
        console.log('Loyalty API response:', response);
        
        if (response && response.success && response.data) {
          loyaltyData = response.data;
          console.log('✓ Loyalty data loaded successfully:', loyaltyData);
          renderLoyaltyDashboard();
        } else {
          console.error('Loyalty API returned unsuccessful response:', response);
          // Show default empty state instead of error
          renderDefaultLoyaltyState();
        }
      } catch (error) {
        console.error('=== LOYALTY LOAD ERROR ===');
        console.error('Error object:', error);
        console.error('Error status:', error.status);
        console.error('Error message:', error.message);
        console.error('Error data:', error.data);
        console.error('Error stack:', error.stack);
        
        // Check if it's an auth error
        if (error.status === 401) {
          const hasToken = !!localStorage.getItem('authToken');
          const tokenPreview = localStorage.getItem('authToken')?.substring(0, 20) + '...';
          
          console.error('401 Unauthorized - Auth failed');
          console.error('Token present:', hasToken);
          console.error('Token preview:', tokenPreview);
          
          let errorMsg = '<strong>Authenticatie mislukt (401)</strong><br>';
          errorMsg += 'Je sessie is verlopen of ongeldig.<br>';
          errorMsg += '<small>Debug: Token aanwezig: ' + (hasToken ? 'Ja' : 'Nee') + '</small><br>';
          errorMsg += '<a href="/login.html?redirect=' + encodeURIComponent(window.location.pathname) + '" class="btn btn--primary" style="margin-top: 10px;">Opnieuw inloggen</a>';
          
          showError(errorMsg);
          return;
        }
        
        // For other errors, show detailed error message
        let errorMsg = '<strong>Fout bij laden loyalty gegevens</strong><br>';
        errorMsg += 'Status: ' + (error.status || 'Onbekend') + '<br>';
        errorMsg += 'Bericht: ' + (error.message || 'Geen details beschikbaar') + '<br>';
        
        if (error.status === 500) {
          errorMsg += '<small>Server error - probeer het later opnieuw</small><br>';
        } else if (error.status === 404) {
          errorMsg += '<small>Loyalty endpoint niet gevonden - mogelijk backend issue</small><br>';
        } else if (!error.status) {
          errorMsg += '<small>Geen verbinding met server - check internet/backend status</small><br>';
        }
        
        errorMsg += '<button onclick="location.reload()" class="btn btn--secondary" style="margin-top: 10px;">Opnieuw proberen</button>';
        
        showError(errorMsg);
      }
    }

    function renderDefaultLoyaltyState() {
      document.getElementById('loyalty-loading').style.display = 'none';
      document.getElementById('loyalty-dashboard').style.display = 'block';

      // Create default data for new users
      const defaultTiers = [
        { id: '1', name: 'Brons', slug: 'bronze', min_points: 0, max_points: 499, discount_percentage: 0, points_boost_percentage: 0, benefits: ['Punten sparen bij elke bestelling', 'Toegang tot loyalty programma'], color: '#CD7F32', gradient_colors: TIER_GRADIENTS.bronze },
        { id: '2', name: 'Zilver', slug: 'silver', min_points: 500, max_points: 1499, discount_percentage: 5, points_boost_percentage: 5, benefits: ['5% korting op alle bestellingen', '+5% extra punten per bestelling'], color: '#C0C0C0', gradient_colors: TIER_GRADIENTS.silver },
        { id: '3', name: 'Goud', slug: 'gold', min_points: 1500, max_points: 2999, discount_percentage: 10, points_boost_percentage: 7, benefits: ['10% korting op alle bestellingen', '+7% extra punten per bestelling'], color: '#FFD700', gradient_colors: TIER_GRADIENTS.gold },
        { id: '4', name: 'Platinum', slug: 'platinum', min_points: 3000, max_points: 4999, discount_percentage: 15, points_boost_percentage: 10, benefits: ['15% korting op alle bestellingen', '+10% extra punten per bestelling'], color: '#E5E4E2', gradient_colors: TIER_GRADIENTS.platinum },
        { id: '5', name: 'Diamant', slug: 'diamond', min_points: 5000, max_points: null, discount_percentage: 20, points_boost_percentage: 15, benefits: ['20% korting op alle bestellingen', '+15% extra punten per bestelling'], color: '#B9F2FF', gradient_colors: TIER_GRADIENTS.diamond }
      ];

      // Render tier slider with default tiers, bronze as current
      renderTierSlider(defaultTiers, '1', 0);

      // Set default values
      document.getElementById('available-points').textContent = '0';
      document.getElementById('lifetime-points').textContent = '0';
      document.getElementById('yearly-spend-display').textContent = '€ 0';
      document.getElementById('current-year').textContent = new Date().getFullYear();
      document.getElementById('redemption-value').textContent = '€ 0,00';

      // Hide yearly progress tag (no retention message for new users)
      const retentionTag = document.getElementById('tier-retention-tag');
      if (retentionTag) retentionTag.style.display = 'none';

      // Set progress bar to 0
      document.getElementById('yearly-progress-fill').style.width = '0%';
      document.getElementById('yearly-progress-mark').style.left = '0%';

      // Show empty transaction history
      document.getElementById('history-container').innerHTML = '<p class="loyalty-history__empty">Nog geen transacties. Plaats je eerste bestelling om punten te verdienen!</p>';
    }

    function renderLoyaltyDashboard() {
      console.log('Rendering loyalty dashboard with data:', loyaltyData);
      
      document.getElementById('loyalty-loading').style.display = 'none';
      document.getElementById('loyalty-dashboard').style.display = 'block';

      const { loyalty, tier, progress, redemption, tiers, yearlySpend } = loyaltyData;

      // Render tier slider using yearly_points (tiers reset each year)
      const yearlyPoints = loyalty?.yearly_points ?? 0;
      renderTierSlider(tiers, tier?.id, yearlyPoints);

      // Update points summary cards
      const availablePoints = loyalty?.available_points ?? 0;
      document.getElementById('available-points').textContent = availablePoints.toLocaleString('nl-NL');
      // Show yearly points instead of lifetime (tiers are based on yearly points)
      document.getElementById('lifetime-points').textContent = yearlyPoints.toLocaleString('nl-NL');

      // Update yearly spend display
      const yearlyAmount = yearlySpend?.amount ?? 0;
      document.getElementById('yearly-spend-display').textContent = `€ ${yearlyAmount.toLocaleString('nl-NL', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}`;
      document.getElementById('current-year').textContent = yearlySpend?.currentYear || new Date().getFullYear();

      // Update yearly progress bar
      renderYearlyProgress(yearlySpend, tier);

      // Update redemption value
      const redemptionValue = redemption?.availableValue ?? 0;
      document.getElementById('redemption-value').textContent = formatPrice(redemptionValue);

      // Load transaction history
      loadTransactionHistory();
    }

    function renderTierSlider(tiers, currentTierId, lifetimePoints) {
      const track = document.getElementById('tier-slider-track');
      const dots = document.getElementById('tier-slider-dots');
      
      if (!track || !tiers || tiers.length === 0) return;

      // Sort tiers by sort_order or min_points
      const sortedTiers = [...tiers].sort((a, b) => (a.sort_order || a.min_points) - (b.sort_order || b.min_points));
      
      // Find current tier index
      let currentIndex = sortedTiers.findIndex(t => t.id === currentTierId);
      if (currentIndex === -1) currentIndex = 0;

      // Render tier cards
      track.innerHTML = sortedTiers.map((t, index) => {
        const isCurrent = t.id === currentTierId;
        const isLocked = lifetimePoints < t.min_points;
        const gradientColors = t.gradient_colors?.length > 0 ? t.gradient_colors : (TIER_GRADIENTS[t.slug] || TIER_GRADIENTS.bronze);
        const bgColor = t.background_color || TIER_BACKGROUNDS[t.slug] || '#FFFFFF';
        
        // Create gradient CSS
        const gradientCSS = `linear-gradient(135deg, ${gradientColors.join(', ')})`;
        
        return `
          <div class="tier-card ${isCurrent ? 'current' : ''} ${isLocked ? 'locked' : ''}" 
               style="background: ${gradientCSS};"
               data-tier-index="${index}">
            ${isCurrent ? '<span class="tier-card__badge">Actief</span>' : ''}
            
            <div class="tier-card__avatar">
              <span class="tier-card__avatar-title">${t.name}</span>
              <span class="tier-card__avatar-label">Membership</span>
            </div>
            
            <div class="tier-card__content">
              <div class="tier-card__title">${t.name}</div>
              
              ${(isLocked && (t.slug === 'platinum' || t.slug === 'diamond')) ? `
                <div class="tier-card__locked">
                  <svg class="tier-card__locked-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                    <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                  </svg>
                  <span class="tier-card__locked-text">Exclusieve voordelen wachten op je</span>
                  <span class="tier-card__locked-subtext">${t.min_points} punten nodig om te ontgrendelen</span>
                </div>
              ` : `
                <div class="tier-card__subtitle">${isLocked ? 'Ontgrendel deze voordelen:' : 'Je voordelen:'}</div>
                <ul class="tier-card__benefits">
                  ${t.discount_percentage > 0 ? `<li><strong>${t.discount_percentage}% korting</strong> op alle bestellingen</li>` : ''}
                  ${t.points_boost_percentage > 0 ? `<li><strong>+${t.points_boost_percentage}%</strong> extra punten per bestelling</li>` : ''}
                  ${(t.benefits || []).filter(b => !b.includes('korting') && !b.includes('punten')).slice(0, 2).map(b => `<li>${b}</li>`).join('')}
                </ul>
                ${isLocked ? `
                  <div class="tier-card__unlock-hint">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                      <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                    </svg>
                    <span>${t.min_points} punten nodig</span>
                  </div>
                ` : ''}
              `}
            </div>
          </div>
        `;
      }).join('');

      // Render dots
      dots.innerHTML = sortedTiers.map((t, index) => `
        <button class="tier-slider__dot ${index === currentIndex ? 'active' : ''}" 
                data-index="${index}" 
                aria-label="Ga naar ${t.name}"></button>
      `).join('');

      // Add dot click handlers
      dots.querySelectorAll('.tier-slider__dot').forEach(dot => {
        dot.addEventListener('click', () => {
          const index = parseInt(dot.dataset.index);
          scrollToTier(index);
          updateActiveDot(index);
        });
      });

      // Scroll to current tier
      setTimeout(() => scrollToTier(currentIndex), 100);

      // Update dots on scroll
      track.addEventListener('scroll', () => {
        const cardWidth = 280 + 16; // card width + gap
        const scrollIndex = Math.round(track.scrollLeft / cardWidth);
        updateActiveDot(scrollIndex);
      });

      // Add drag/swipe functionality
      let isDragging = false;
      let startX = 0;
      let scrollLeft = 0;

      track.addEventListener('mousedown', (e) => {
        isDragging = true;
        track.style.cursor = 'grabbing';
        track.style.userSelect = 'none';
        startX = e.pageX - track.offsetLeft;
        scrollLeft = track.scrollLeft;
      });

      track.addEventListener('mouseleave', () => {
        isDragging = false;
        track.style.cursor = 'grab';
      });

      track.addEventListener('mouseup', () => {
        isDragging = false;
        track.style.cursor = 'grab';
      });

      track.addEventListener('mousemove', (e) => {
        if (!isDragging) return;
        e.preventDefault();
        const x = e.pageX - track.offsetLeft;
        const walk = (x - startX) * 2; // Scroll speed multiplier
        track.scrollLeft = scrollLeft - walk;
      });

      // Set initial cursor
      track.style.cursor = 'grab';
    }

    function scrollToTier(index) {
      const track = document.getElementById('tier-slider-track');
      const cardWidth = 280 + 16; // card width + gap
      track.scrollTo({ left: index * cardWidth, behavior: 'smooth' });
    }

    function updateActiveDot(activeIndex) {
      const dots = document.querySelectorAll('.tier-slider__dot');
      dots.forEach((dot, index) => {
        dot.classList.toggle('active', index === activeIndex);
      });
    }

    function renderYearlyProgress(yearlySpend, currentTier) {
      if (!yearlySpend) return;

      const { amount, amountToKeepTier, tierRetentionMessage } = yearlySpend;
      
      // Calculate progress percentage (max at next tier threshold or 5000)
      const maxAmount = Math.max(amountToKeepTier, 5000);
      const progressPercent = Math.min(100, (amount / maxAmount) * 100);
      
      // Update progress bar
      document.getElementById('yearly-progress-fill').style.width = `${progressPercent}%`;
      document.getElementById('yearly-progress-mark').style.left = `${progressPercent}%`;

      // Update tier retention tag (loss aversion message)
      const retentionTag = document.getElementById('tier-retention-tag');
      if (tierRetentionMessage) {
        retentionTag.textContent = tierRetentionMessage;
        retentionTag.style.display = 'inline-block';
      } else if (currentTier && currentTier.slug !== 'bronze') {
        retentionTag.textContent = `${currentTier.name} status behaald!`;
        retentionTag.style.background = '#D4EDDA';
        retentionTag.style.color = '#155724';
        retentionTag.style.display = 'inline-block';
      } else {
        retentionTag.style.display = 'none';
      }

      // Update progress point labels
      const midPoint = Math.round(maxAmount / 2);
      document.getElementById('yearly-mid-point').textContent = `€ ${midPoint.toLocaleString('nl-NL')}`;
      document.getElementById('yearly-max-point').textContent = `€ ${maxAmount.toLocaleString('nl-NL')}`;
    }

    async function loadTransactionHistory() {
      try {
        const response = await loyaltyAPI.getHistory(20);
        
        if (response.success && response.data.length > 0) {
          renderTransactionHistory(response.data);
        }
      } catch (error) {
        console.error('History load error:', error);
      }
    }

    function renderTransactionHistory(transactions) {
      const container = document.getElementById('history-container');
      
      container.innerHTML = `
        <ul class="loyalty-history__list">
          ${transactions.map(t => `
            <li class="loyalty-history__item">
              <div class="loyalty-history__info">
                <div class="loyalty-history__description">${t.description || getTransactionTypeLabel(t.transaction_type)}</div>
                <div class="loyalty-history__date">${formatDate(t.created_at)}</div>
              </div>
              <div class="loyalty-history__points ${t.points >= 0 ? 'positive' : 'negative'}">
                ${t.points.toLocaleString('nl-NL')}
              </div>
            </li>
          `).join('')}
        </ul>
      `;
    }

    function getTransactionTypeLabel(type) {
      const labels = {
        'earned': 'Punten verdiend',
        'redeemed': 'Punten ingewisseld',
        'bonus': 'Bonus punten',
        'expired': 'Punten verlopen',
        'adjustment': 'Aanpassing'
      };
      return labels[type] || type;
    }

    function showError(message) {
      document.getElementById('loyalty-loading').innerHTML = `
        <div style="text-align: center; padding: var(--space-xl); color: var(--color-error);">
          <p>${message}</p>
          <button class="btn btn--secondary" onclick="location.reload()">Opnieuw proberen</button>
        </div>
      `;
    }
  </script>
</body>
</html>
